<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Repair Assistant</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>

    <script>

      function renderMarkdownToHtml(markdown) {
        // Convert markdown â†’ HTML and sanitize to avoid XSS
        return DOMPurify.sanitize(marked.parse(markdown || ''));
      }

      // Example: replace your current code that appends model text with this:
      async function sendChatMessage(message) {
        // send via fetch/socket like your existing code
        const res = await fetch('/chat', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({message})
        });
        const data = await res.json();
        if (data.success) {
          const html = renderMarkdownToHtml(data.response);
          // append sanitized HTML to your chat container
          document.getElementById('chat').insertAdjacentHTML('beforeend',
            `<div class="bot-message">${html}</div>`);
        }
      }

      // If you handle /process_frame responses similarly:
      async function handleFrameResponse(respJson) {
        if (respJson.success) {
          const html = renderMarkdownToHtml(respJson.response);
          document.getElementById('chat').insertAdjacentHTML('beforeend',
            `<div class="bot-message">${html}</div>`);
        }
      }

    </script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: 100vh;
        overflow: hidden;
      }

      .container {
        display: flex;
        height: 100vh;
        gap: 20px;
        padding: 20px;
      }

      .video-section {
        flex: 1;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
      }

      .chat-section {
        flex: 1;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
      }

      .video-container {
        flex: 1;
        position: relative;
        background: #000;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 20px;
      }

      #videoElement {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .controls {
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .btn-primary {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
        background: linear-gradient(45deg, #f093fb, #f5576c);
        color: white;
      }

      .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(240, 147, 251, 0.4);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .chat-header {
        font-size: 24px;
        font-weight: 700;
        color: #333;
        margin-bottom: 20px;
        text-align: center;
        background: linear-gradient(45deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .chat-messages {
        display: flex;
        flex-direction: column;
        gap: 10px;
        flex: 1 1 auto;
        overflow-y: auto;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 10px;
        max-height: none;
        min-height: 0; /* ensures flexbox can shrink */
      }

      .message {
        display: inline-block;
        padding: 12px 16px;
        border-radius: 15px;
        max-width: 80%;
        width: auto; /* allow bubble to size to content */
        word-wrap: break-word;
        white-space: normal;
        animation: fadeIn 0.3s ease;
      }

      .message.user {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        align-self: flex-end; /* right-align user messages */
        text-align: right;
        margin-left: 0;
      }

      .message.system {
        background: #e9ecef;
        color: #333;
        align-self: flex-start; /* left-align system messages */
        text-align: left;
        margin-right: 0;
      }

      .message.system.image-processed {
        border-left: 4px solid #28a745;
      }

      .chat-input-container {
        display: flex;
        gap: 10px;
      }

      .chat-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        font-size: 16px;
        outline: none;
        transition: border-color 0.3s ease;
      }

      .chat-input:focus {
        border-color: #667eea;
      }

      .status {
        text-align: center;
        padding: 10px;
        margin: 10px 0;
        border-radius: 10px;
        font-weight: 600;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Video Section -->
      <div class="video-section">
        <h2 style="text-align: center; margin-bottom: 20px; color: #333">
          Live Camera Feed
        </h2>
        <div class="video-container">
          <video id="videoElement" autoplay muted></video>
        </div>
        <div class="controls">
          <button id="startCamera" class="btn btn-primary">Start Camera</button>
          <button id="captureFrame" class="btn btn-secondary" disabled>
            Analyze Object
          </button>
          <button id="stopCamera" class="btn btn-secondary" disabled>
            Stop Camera
          </button>
        </div>
        <div id="status" class="status hidden"></div>
      </div>

      <!-- Chat Section -->
      <div class="chat-section">
        <h2 class="chat-header">AI Repair Assistant</h2>
        <div class="chat-messages" id="chatMessages">
          <div class="message system">
            <strong>Welcome!</strong><br />
            Start your camera and point it at the object you need help with.
            Click "Analyze Object" to get step-by-step repair instructions.
          </div>
        </div>
        <div class="chat-input-container">
          <input
            type="text"
            id="chatInput"
            class="chat-input"
            placeholder="Ask a follow-up question..."
          />
          <button id="sendMessage" class="btn btn-primary">Send</button>
        </div>
      </div>
    </div>

    <script>
      class RepairAssistant {
        constructor() {
          this.video = document.getElementById("videoElement");
          this.canvas = document.createElement("canvas");
          this.ctx = this.canvas.getContext("2d");
          this.stream = null;
          this.isProcessing = false;

          this.initializeElements();
          this.initializeSocket();
          this.loadChatHistory();
        }

        initializeElements() {
          this.startCameraBtn = document.getElementById("startCamera");
          this.captureFrameBtn = document.getElementById("captureFrame");
          this.stopCameraBtn = document.getElementById("stopCamera");
          this.chatInput = document.getElementById("chatInput");
          this.sendMessageBtn = document.getElementById("sendMessage");
          this.chatMessages = document.getElementById("chatMessages");
          this.status = document.getElementById("status");

          this.startCameraBtn.addEventListener("click", () =>
            this.startCamera()
          );
          this.captureFrameBtn.addEventListener("click", () =>
            this.captureAndAnalyze()
          );
          this.stopCameraBtn.addEventListener("click", () => this.stopCamera());
          this.sendMessageBtn.addEventListener("click", () =>
            this.sendMessage()
          );
          this.chatInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") this.sendMessage();
          });
        }

        initializeSocket() {
          this.socket = io();
          this.socket.on("connect", () => {
            console.log("Connected to server");
          });
        }

        async startCamera() {
          try {
            this.showStatus("Starting camera...", "info");
            this.stream = await navigator.mediaDevices.getUserMedia({
              video: {
                width: { ideal: 1280 },
                height: { ideal: 720 },
              },
            });

            this.video.srcObject = this.stream;
            this.startCameraBtn.disabled = true;
            this.captureFrameBtn.disabled = false;
            this.stopCameraBtn.disabled = false;
            this.chatInput.disabled = false;
            this.sendMessageBtn.disabled = false;

            this.showStatus("Camera started successfully!", "success");
            setTimeout(() => this.hideStatus(), 3000);
          } catch (error) {
            console.error("Error accessing camera:", error);
            this.showStatus(
              "Error accessing camera. Please check permissions.",
              "error"
            );
          }
        }

        stopCamera() {
          if (this.stream) {
            this.stream.getTracks().forEach((track) => track.stop());
            this.stream = null;
          }

          this.video.srcObject = null;
          this.startCameraBtn.disabled = false;
          this.captureFrameBtn.disabled = true;
          this.stopCameraBtn.disabled = true;
          this.chatInput.disabled = true;
          this.sendMessageBtn.disabled = true;

          this.showStatus("Camera stopped.", "info");
          setTimeout(() => this.hideStatus(), 3000);
        }

        async captureAndAnalyze() {
          if (this.isProcessing) return;

          this.isProcessing = true;
          this.captureFrameBtn.disabled = true;
          this.showStatus("Analyzing object...", "info");

          try {
            // Set canvas dimensions to match video
            this.canvas.width = this.video.videoWidth;
            this.canvas.height = this.video.videoHeight;

            // Draw current video frame to canvas
            this.ctx.drawImage(this.video, 0, 0);

            // Convert to base64
            const imageData = this.canvas.toDataURL("image/jpeg", 0.8);

            // Send to server for processing
            const response = await fetch("/process_frame", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ image: imageData }),
            });

            const result = await response.json();

            if (result.success) {
              this.addMessage(result.response, "system", true);
              this.showStatus("Analysis complete!", "success");
            } else {
              throw new Error(result.error || "Analysis failed");
            }
          } catch (error) {
            console.error("Error analyzing frame:", error);
            this.showStatus(
              "Error analyzing object: " + error.message,
              "error"
            );
          } finally {
            this.isProcessing = false;
            this.captureFrameBtn.disabled = false;
            setTimeout(() => this.hideStatus(), 3000);
          }
        }

        async sendMessage() {
          const message = this.chatInput.value.trim();
          if (!message) return;

          this.addMessage(message, "user");
          this.chatInput.value = "";
          this.sendMessageBtn.disabled = true;

          try {
            const response = await fetch("/chat", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ message: message }),
            });

            const result = await response.json();

            if (result.success) {
              this.addMessage(result.response, "system");
            } else {
              throw new Error(result.error || "Chat failed");
            }
          } catch (error) {
            console.error("Error sending message:", error);
            this.addMessage(
              "Sorry, there was an error processing your message.",
              "system"
            );
          } finally {
            this.sendMessageBtn.disabled = false;
          }
        }

        addMessage(text, type, isImageProcessed = false) {
          const messageDiv = document.createElement("div");
          messageDiv.className = `message ${type}`;
          if (isImageProcessed) {
            messageDiv.classList.add("image-processed");
          }

          // Format the text with line breaks
          const formattedText = text.replace(/\n/g, "<br>");
          messageDiv.innerHTML = formattedText;

          this.chatMessages.appendChild(messageDiv);
          this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
        }

        showStatus(message, type) {
          this.status.textContent = message;
          this.status.className = `status ${type}`;
          this.status.classList.remove("hidden");
        }

        hideStatus() {
          this.status.classList.add("hidden");
        }

        async loadChatHistory() {
          try {
            const response = await fetch("/get_chat_history");
            const history = await response.json();

            // Clear existing messages except welcome message
            this.chatMessages.innerHTML = "";

            if (history.length === 0) {
              this.addMessage(
                'Welcome! Start your camera and point it at the object you need help with. Click "Analyze Object" to get step-by-step repair instructions.',
                "system"
              );
            } else {
              history.forEach((entry) => {
                this.addMessage(
                  entry.message,
                  entry.type,
                  entry.image_processed
                );
              });
            }
          } catch (error) {
            console.error("Error loading chat history:", error);
          }
        }
      }

      // Initialize the app when the page loads
      document.addEventListener("DOMContentLoaded", () => {
        new RepairAssistant();
      });
    </script>
  </body>
</html>
